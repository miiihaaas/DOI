<!-- Full Activity Log Page -->
<!-- Comprehensive activity log view with advanced filtering and search -->

{% extends "base.html" %}
{% from 'activity/activity_timeline.html' import render_activity_timeline %}

{% block title %}Activity Log - DOI Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-history text-primary me-2"></i>
                Activity Log
            </h1>
            <p class="text-muted mb-0">
                Comprehensive audit trail of all system activities
            </p>
        </div>
        
        <!-- Header Actions -->
        <div class="d-flex align-items-center">
            {% if current_user.is_admin %}
            <a href="{{ url_for('admin.activity_management') }}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-cog me-1"></i>
                Manage Activities
            </a>
            {% endif %}
            
            <button class="btn btn-primary" onclick="exportActivities()">
                <i class="fas fa-download me-1"></i>
                Export CSV
            </button>
        </div>
    </div>
    
    <!-- Activity Statistics Overview -->
    {% if activity_stats %}
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="card-title h5">{{ activity_stats.total_activities }}</div>
                            <div class="small">Total Activities</div>
                            <div class="text-primary-light small">Last {{ activity_stats.period_days }} days</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% for action, count in activity_stats.action_breakdown.items() %}
            {% if loop.index <= 3 %}
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="card-title h5">{{ count }}</div>
                                <div class="small text-muted">{{ action|title }} Actions</div>
                            </div>
                            <div class="align-self-center">
                                {% if action == 'create' %}
                                    <i class="fas fa-plus fa-2x text-success opacity-75"></i>
                                {% elif action == 'update' %}
                                    <i class="fas fa-edit fa-2x text-primary opacity-75"></i>
                                {% elif action == 'delete' %}
                                    <i class="fas fa-trash fa-2x text-danger opacity-75"></i>
                                {% else %}
                                    <i class="fas fa-activity fa-2x text-info opacity-75"></i>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Advanced Filtering Panel -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link text-decoration-none p-0" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#filterPanel" 
                        aria-expanded="false" aria-controls="filterPanel">
                    <i class="fas fa-filter me-2"></i>Advanced Filters
                    <i class="fas fa-chevron-down ms-2"></i>
                </button>
            </h5>
        </div>
        <div class="collapse" id="filterPanel">
            <div class="card-body">
                <form method="GET" action="{{ url_for('activity.activity_log') }}">
                    <div class="row g-3">
                        <!-- Date Range -->
                        <div class="col-md-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" 
                                   value="{{ request.args.get('start_date', '') }}">
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" 
                                   value="{{ request.args.get('end_date', '') }}">
                        </div>
                        
                        <!-- User Filter -->
                        <div class="col-md-3">
                            <label for="user_id" class="form-label">User</label>
                            <select class="form-select" id="user_id" name="user_id">
                                <option value="">All Users</option>
                                {% for user in available_users %}
                                <option value="{{ user.id }}" 
                                        {% if request.args.get('user_id') == user.id|string %}selected{% endif %}>
                                    {{ user.full_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Action Type Filter -->
                        <div class="col-md-3">
                            <label for="action_type" class="form-label">Action Type</label>
                            <select class="form-select" id="action_type" name="action_type">
                                <option value="">All Actions</option>
                                <option value="create" {% if request.args.get('action_type') == 'create' %}selected{% endif %}>
                                    Create
                                </option>
                                <option value="update" {% if request.args.get('action_type') == 'update' %}selected{% endif %}>
                                    Update
                                </option>
                                <option value="activate" {% if request.args.get('action_type') == 'activate' %}selected{% endif %}>
                                    Activate
                                </option>
                                <option value="deactivate" {% if request.args.get('action_type') == 'deactivate' %}selected{% endif %}>
                                    Deactivate
                                </option>
                                <option value="delete" {% if request.args.get('action_type') == 'delete' %}selected{% endif %}>
                                    Delete
                                </option>
                            </select>
                        </div>
                        
                        <!-- Search Term -->
                        <div class="col-md-6">
                            <label for="search" class="form-label">Search Description</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   placeholder="Search in activity descriptions..." 
                                   value="{{ request.args.get('search', '') }}">
                        </div>
                        
                        <!-- IP Address Filter -->
                        <div class="col-md-3">
                            <label for="ip_address" class="form-label">IP Address</label>
                            <input type="text" class="form-control" id="ip_address" name="ip_address" 
                                   placeholder="e.g., 192.168.1.1" 
                                   value="{{ request.args.get('ip_address', '') }}">
                        </div>
                        
                        <!-- Items per page -->
                        <div class="col-md-3">
                            <label for="per_page" class="form-label">Items per Page</label>
                            <select class="form-select" id="per_page" name="per_page">
                                <option value="10" {% if request.args.get('per_page', '20') == '10' %}selected{% endif %}>10</option>
                                <option value="20" {% if request.args.get('per_page', '20') == '20' %}selected{% endif %}>20</option>
                                <option value="50" {% if request.args.get('per_page', '20') == '50' %}selected{% endif %}>50</option>
                                <option value="100" {% if request.args.get('per_page', '20') == '100' %}selected{% endif %}>100</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Filter Actions -->
                    <div class="row g-2 mt-3">
                        <div class="col-auto">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i>Apply Filters
                            </button>
                        </div>
                        <div class="col-auto">
                            <a href="{{ url_for('activity.activity_log') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>Clear Filters
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Activity Results -->
    <div class="row">
        <div class="col-12">
            <!-- Activity Timeline Component -->
            {{ render_activity_timeline(
                activities=activities,
                title="Activity Log Results" if request.args else "Recent Activity",
                show_filters=false,
                show_pagination=true,
                pagination_obj=pagination
            ) }}
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">Export Activity Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm" action="{{ url_for('activity.export_activities') }}" method="POST">
                    <div class="mb-3">
                        <label for="export_format" class="form-label">Export Format</label>
                        <select class="form-select" id="export_format" name="format">
                            <option value="csv">CSV (Comma Separated)</option>
                            <option value="xlsx">Excel Spreadsheet</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="export_date_range" class="form-label">Date Range</label>
                        <select class="form-select" id="export_date_range" name="date_range">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    
                    <div id="customDateRange" style="display: none;">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label for="export_start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="export_start_date" name="start_date">
                            </div>
                            <div class="col-6">
                                <label for="export_end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="export_end_date" name="end_date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include_ip" name="include_ip" checked>
                            <label class="form-check-label" for="include_ip">
                                Include IP Addresses
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include_entity_refs" name="include_entity_refs" checked>
                            <label class="form-check-label" for="include_entity_refs">
                                Include Entity References (Member/Publication IDs)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="exportForm" class="btn btn-primary">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Show/hide custom date range fields
document.getElementById('export_date_range').addEventListener('change', function() {
    const customRange = document.getElementById('customDateRange');
    if (this.value === 'custom') {
        customRange.style.display = 'block';
    } else {
        customRange.style.display = 'none';
    }
});

// Export activities function
function exportActivities() {
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

// Auto-refresh functionality (every 30 seconds)
let refreshInterval;

function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        if (!document.hidden) {
            // Only refresh the timeline content, not the entire page
            fetch(window.location.href, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'text/html'
                }
            })
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTimeline = doc.querySelector('#activityTimeline');
                if (newTimeline) {
                    document.getElementById('activityTimeline').innerHTML = newTimeline.innerHTML;
                }
            })
            .catch(error => console.error('Auto-refresh failed:', error));
        }
    }, 30000); // 30 seconds
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// Start auto-refresh when page loads (if no filters are applied)
document.addEventListener('DOMContentLoaded', () => {
    if (!window.location.search) {
        startAutoRefresh();
    }
});

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        if (!window.location.search) {
            startAutoRefresh();
        }
    }
});
</script>

{% endblock %}