{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-journal-text"></i> Publikacije za {{ member.name }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('members.index') }}">Članovi</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('members.detail', member_id=member.id) }}">{{ member.name }}</a></li>
                    <li class="breadcrumb-item active">Publikacije</li>
                </ol>
            </nav>
        </div>
        <a href="{{ url_for('publications.create_for_member', member_id=member.id) }}" class="btn btn-success">
            <i class="bi bi-journal-plus"></i> Nova publikacija
        </a>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="statistics-cards">
        {% include 'publications/includes/statistics-cards.html' %}
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-center" id="filter-form">
                <div class="col-md-4">
                    <label for="type" class="form-label">Filter po tipu</label>
                    <select name="type" id="type" class="form-select">
                        <option value="">Svi tipovi</option>
                        {% for value, label in publication_types %}
                            <option value="{{ value }}" {% if current_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" id="reset-filter" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                </div>
                <div class="col-md-2">
                    <div id="loading-spinner" class="spinner-border spinner-border-sm text-primary" style="display: none;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Publications Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-list"></i> Lista publikacija
                <span id="filter-label">
                    {% if current_filter %}
                        <small class="text-muted">- {{ current_filter.replace('_', ' ').title() }}</small>
                    {% endif %}
                </span>
            </h5>
        </div>
        <div class="card-body" id="publications-table-container">
            {% include 'publications/includes/publications-table.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
const memberId = {{ member.id }};
let currentFilter = '{{ current_filter }}';
let currentPage = 1;

// DOM elements
const typeSelect = document.getElementById('type');
const resetButton = document.getElementById('reset-filter');
const loadingSpinner = document.getElementById('loading-spinner');
const tableContainer = document.getElementById('publications-table-container');
const statsCards = document.getElementById('statistics-cards');
const filterLabel = document.getElementById('filter-label');

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Filter change event
    typeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        filterPublications(selectedType, 1);
    });
    
    // Reset filter event
    resetButton.addEventListener('click', function() {
        typeSelect.value = '';
        filterPublications('', 1);
    });
    
    // Pagination click events (delegated)
    document.addEventListener('click', function(e) {
        if (e.target.closest('#ajax-pagination a[data-page]')) {
            e.preventDefault();
            const page = parseInt(e.target.closest('a').getAttribute('data-page'));
            filterPublications(currentFilter, page);
        }
    });
});

// Main filter function
function filterPublications(type, page) {
    // Show loading spinner
    loadingSpinner.style.display = 'inline-block';
    
    // Build URL parameters
    const params = new URLSearchParams();
    if (type) params.append('type', type);
    if (page && page > 1) params.append('page', page);
    
    // Make AJAX request
    fetch(`/publications/api/member/${memberId}/filter?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update table content
                tableContainer.innerHTML = data.publications_html;
                
                // Update statistics cards
                statsCards.innerHTML = data.stats_html;
                
                // Update filter label
                updateFilterLabel(type);
                
                // Update current state
                currentFilter = type;
                currentPage = page;
                
                // Update URL without reload
                updateURL(type, page);
                
            } else {
                alert('Greška: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Greška:', error);
            alert('Došlo je do greške prilikom filtriranja.');
        })
        .finally(() => {
            // Hide loading spinner
            loadingSpinner.style.display = 'none';
        });
}

// Update filter label
function updateFilterLabel(type) {
    if (type) {
        const typeLabels = {
            'journal': 'Časopis',
            'book_series': 'Serija Knjiga', 
            'book_set': 'Komplet Knjiga',
            'book': 'Knjiga'
        };
        filterLabel.innerHTML = `<small class="text-muted">- ${typeLabels[type]}</small>`;
    } else {
        filterLabel.innerHTML = '';
    }
}

// Update browser URL without reload
function updateURL(type, page) {
    const params = new URLSearchParams();
    if (type) params.append('type', type);
    if (page && page > 1) params.append('page', page);
    
    const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.history.replaceState({}, '', newUrl);
}

// Toggle status function (existing)
function toggleStatus(publicationId, currentStatus) {
    const isActive = currentStatus === 'True';
    const action = isActive ? 'deaktivaciju' : 'aktivaciju';
    
    if (confirm(`Da li ste sigurni da želite ${action} ove publikacije?`)) {
        fetch(`/publications/${publicationId}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Refresh current view instead of full reload
                filterPublications(currentFilter, currentPage);
            } else {
                alert('Greška: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Greška:', error);
            alert('Došlo je do greške prilikom izmene statusa.');
        });
    }
}
</script>
{% endblock %}