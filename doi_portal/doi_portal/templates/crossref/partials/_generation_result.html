{# Story 5.3: XML Generation for All Publication Types #}
{# Story 5.4: XSD Validation - Updated with validation status #}
{# Story 5.5: XML Preview with Syntax Highlighting #}
{# Story 5.6: XML Download - Smart download button with warning check #}
{# Generation result template for Crossref XML generation #}

{% if generating %}
<div class="alert alert-info" id="generation-result">
  <div class="d-flex align-items-center">
    <div class="spinner-border spinner-border-sm me-2" role="status">
      <span class="visually-hidden">Generisanje...</span>
    </div>
    <span>{{ message }}</span>
  </div>
  {# Task polling will be implemented in future stories #}
  <small class="d-block text-muted mt-2">
    Osve≈æite stranicu za pregled statusa.
  </small>
</div>

{% elif success %}
<div class="card mb-3" id="generation-result">
  {# Generation success header #}
  <div class="card-header bg-success-subtle">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <i class="bi bi-check-circle-fill text-success me-2"></i>
        <strong>{{ message }}</strong>
        {% if timestamp %}
        <small class="text-muted d-block mt-1">
          Generisano: {{ timestamp|date:"d.m.Y H:i" }}
        </small>
        {% endif %}
      </div>
      {# Story 5.5: XML Preview and Download buttons #}
      {# Story 5.6: Smart download with warning check for invalid XML #}
      {% if issue %}
      <div class="d-flex gap-2">
        <button type="button"
                class="btn btn-sm btn-outline-info"
                hx-get="{% url 'crossref:xml-preview' issue.pk %}"
                hx-target="body"
                hx-swap="beforeend">
          <i class="bi bi-eye me-1"></i>Pregled XML
        </button>
        {% if xsd_valid %}
        {# Direct download for valid XML #}
        <a href="{% url 'crossref:xml-download' issue.pk %}"
           class="btn btn-sm btn-outline-primary"
           download>
          <i class="bi bi-download me-1"></i>Preuzmi XML
        </a>
        {% else %}
        {# Show warning first for invalid XML (Story 5.6 AC4) #}
        <button type="button"
                class="btn btn-sm btn-outline-warning"
                hx-get="{% url 'crossref:download-warning' issue.pk %}"
                hx-target="body"
                hx-swap="beforeend">
          <i class="bi bi-download me-1"></i>Preuzmi XML
          <i class="bi bi-exclamation-triangle ms-1"></i>
        </button>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  {# XSD Validation Status (Story 5.4) #}
  <div class="card-body p-2">
    {% include "crossref/partials/_xsd_validation_result.html" %}
  </div>
</div>

{# Story 5.6: Export History Section (AC5) #}
{% if issue %}
<div id="export-history-container"
     hx-get="{% url 'crossref:export-history' issue.pk %}"
     hx-trigger="load, htmx:afterRequest from:body"
     hx-swap="innerHTML">
  {# Export history will be loaded via HTMX #}
</div>
{% endif %}

{% else %}
{# Generation failed #}
<div class="alert alert-danger mb-0" id="generation-result">
  <div class="d-flex align-items-start">
    <i class="bi bi-x-circle-fill me-2 mt-1"></i>
    <div>
      <strong>{{ message }}</strong>
      {% if errors %}
        <ul class="mb-0 mt-2 ps-3">
          {% for error in errors %}
            <li>
              {{ error.message }}
              {% if error.fix_url %}
                <a href="{{ error.fix_url }}" class="ms-2 text-danger">
                  <i class="bi bi-pencil-square"></i> Ispravi
                </a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}
