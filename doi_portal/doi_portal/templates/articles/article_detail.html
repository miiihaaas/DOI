{% extends "admin_base.html" %}

{% block title %}{{ article.title }} - DOI Portal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-file-earmark-text me-2"></i>{{ article.title }}
    </h1>
    <div>
        {% if can_edit %}
        <a href="{% url 'articles:update' article.pk %}" class="btn btn-primary">
            <i class="bi bi-pencil me-1"></i>Izmeni
        </a>
        {% endif %}
        {% if can_delete %}
        <a href="{% url 'articles:delete' article.pk %}" class="btn btn-outline-danger ms-2">
            <i class="bi bi-trash me-1"></i>Obriši
        </a>
        {% endif %}
    </div>
</div>

{% if is_in_review %}
<div class="alert alert-info mb-4">
    <i class="bi bi-hourglass-split me-2"></i>
    <strong>Članak čeka odobrenje urednika.</strong>
    {% if article.submitted_at %}
    <br><small class="text-muted">Poslat: {{ article.submitted_at|date:"d.m.Y. H:i" }}
    {% if article.submitted_by %} od {{ article.submitted_by }}{% endif %}</small>
    {% endif %}
</div>
{% endif %}

{% if is_ready %}
<div class="alert alert-primary mb-4">
    <i class="bi bi-check2-circle me-2"></i>
    <strong>Članak je odobren i spreman za objavu.</strong>
    {% if article.reviewed_at %}
    <br><small class="text-muted">Odobren: {{ article.reviewed_at|date:"d.m.Y. H:i" }}
    {% if article.reviewed_by %} od {{ article.reviewed_by }}{% endif %}</small>
    {% endif %}
</div>
{% endif %}

{% if is_published %}
<div class="alert alert-success mb-4">
    <i class="bi bi-globe me-2"></i>
    <strong>Članak je objavljen.</strong>
    {% if article.published_at %}
    <br><small class="text-muted">Objavljeno: {{ article.published_at|date:"d.m.Y. H:i" }}
    {% if article.published_by %} od {{ article.published_by }}{% endif %}</small>
    {% endif %}
</div>
{% endif %}

{% if is_withdrawn %}
<div class="alert alert-danger mb-4">
    <i class="bi bi-x-circle me-2"></i>
    <strong>Članak je povučen.</strong>
    {% if article.withdrawal_reason %}
    <p class="mb-0 mt-1"><strong>Razlog:</strong> {{ article.withdrawal_reason|linebreaksbr }}</p>
    {% endif %}
    {% if article.withdrawn_at %}
    <small class="text-muted">Povučeno: {{ article.withdrawn_at|date:"d.m.Y. H:i" }}
    {% if article.withdrawn_by %} od {{ article.withdrawn_by }}{% endif %}</small>
    {% endif %}
</div>
{% endif %}

{% if has_revision_comment %}
<div class="alert alert-warning mb-4">
    <i class="bi bi-chat-left-text me-2"></i>
    <strong>Komentar urednika:</strong>
    <p class="mb-0 mt-1">{{ article.revision_comment }}</p>
    {% if article.returned_at %}
    <small class="text-muted">Vraćeno: {{ article.returned_at|date:"d.m.Y. H:i" }}
    {% if article.returned_by %} od {{ article.returned_by }}{% endif %}</small>
    {% endif %}
</div>
{% endif %}

<div class="row">
    <!-- Main Info Card -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Osnovne informacije</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-3">Naslov</dt>
                    <dd class="col-sm-9">{{ article.title }}</dd>

                    {% if article.subtitle %}
                    <dt class="col-sm-3">Podnaslov</dt>
                    <dd class="col-sm-9">{{ article.subtitle }}</dd>
                    {% endif %}

                    <dt class="col-sm-3">Izdanje</dt>
                    <dd class="col-sm-9">
                        {{ article.issue }}
                    </dd>

                    <dt class="col-sm-3">Publikacija</dt>
                    <dd class="col-sm-9">
                        {{ article.issue.publication.title }}
                    </dd>

                    <dt class="col-sm-3">Izdavač</dt>
                    <dd class="col-sm-9">
                        {{ article.issue.publication.publisher.name }}
                    </dd>

                    <dt class="col-sm-3">DOI sufiks</dt>
                    <dd class="col-sm-9">{{ article.doi_suffix }}</dd>

                    <dt class="col-sm-3">Status</dt>
                    <dd class="col-sm-9">
                        <span class="badge {{ article.status_badge_class }}">
                            {{ article.get_status_display }}
                        </span>
                    </dd>

                    <dt class="col-sm-3">Jezik</dt>
                    <dd class="col-sm-9">{{ article.language }}</dd>

                    <dt class="col-sm-3">Tip sadržaja</dt>
                    <dd class="col-sm-9">{{ article.get_publication_type_display }}</dd>
                </dl>
            </div>
        </div>

        <!-- Abstract Section -->
        {% if article.abstract %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-text-paragraph me-2"></i>Apstrakt</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ article.abstract }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Keywords Section -->
        {% if article.keywords %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-tags me-2"></i>Ključne reči</h5>
            </div>
            <div class="card-body">
                {% for keyword in article.keywords %}
                <span class="badge bg-primary me-1 mb-1">{{ keyword }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Authors Section (Story 3.2) -->
        {% if authors %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Autori ({{ authors|length }})</h5>
            </div>
            <div class="card-body">
                {% for author in authors %}
                <div class="{% if not forloop.last %}border-bottom pb-2 mb-2{% endif %}">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <strong>{{ author.surname }}{% if author.given_name %}, {{ author.given_name }}{% endif %}</strong>
                            {% if author.suffix %}
                                <span class="text-muted">{{ author.suffix }}</span>
                            {% endif %}
                            <span class="badge bg-info ms-1">{{ author.get_contributor_role_display }}</span>
                            {% if author.is_corresponding %}
                                <span class="badge bg-warning ms-1">Korespondentan</span>
                            {% endif %}
                            <span class="badge bg-{% if author.sequence == 'first' %}primary{% else %}secondary{% endif %} ms-1">
                                {{ author.get_sequence_display }}
                            </span>
                        </div>
                    </div>
                    {% if author.orcid %}
                    <div class="mt-1">
                        <small class="text-success">
                            <i class="bi bi-check-circle me-1"></i>ORCID: {{ author.orcid }}
                        </small>
                    </div>
                    {% endif %}
                    {% if author.email %}
                    <div>
                        <small class="text-muted">
                            <i class="bi bi-envelope me-1"></i>{{ author.email }}
                        </small>
                    </div>
                    {% endif %}
                    {% for aff in author.affiliations.all %}
                    <div>
                        <small class="text-muted">
                            <i class="bi bi-building me-1"></i>{{ aff.institution_name }}{% if aff.department %}, {{ aff.department }}{% endif %}
                            {% if aff.institution_ror_id %}
                                <a href="{{ aff.institution_ror_id }}" target="_blank"><i class="bi bi-box-arrow-up-right"></i></a>
                            {% endif %}
                        </small>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Pages/Identification Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bookmark me-2"></i>Stranice i identifikacija</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    {% if article.first_page %}
                    <dt class="col-sm-3">Prva stranica</dt>
                    <dd class="col-sm-9">{{ article.first_page }}</dd>
                    {% endif %}

                    {% if article.last_page %}
                    <dt class="col-sm-3">Poslednja stranica</dt>
                    <dd class="col-sm-9">{{ article.last_page }}</dd>
                    {% endif %}

                    {% if article.article_number %}
                    <dt class="col-sm-3">Broj članka</dt>
                    <dd class="col-sm-9">{{ article.article_number }}</dd>
                    {% endif %}
                </dl>
                {% if not article.first_page and not article.last_page and not article.article_number %}
                <p class="text-muted mb-0">Nema unetih podataka o stranicama.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- License/Access Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Licenca i pristup</h5>
            </div>
            <div class="card-body">
                <dl class="mb-0">
                    {% if article.license_url %}
                    <dt>URL licence</dt>
                    <dd><a href="{{ article.license_url }}" target="_blank">{{ article.license_url }}</a></dd>
                    {% endif %}

                    {% if article.license_applies_to %}
                    <dt>Licenca se odnosi na</dt>
                    <dd>{{ article.get_license_applies_to_display }}</dd>
                    {% endif %}

                    <dt>Slobodan pristup</dt>
                    <dd>
                        {% if article.free_to_read %}
                        <span class="badge bg-success">Da</span>
                        {% else %}
                        <span class="badge bg-secondary">Ne</span>
                        {% endif %}
                    </dd>

                    {% if article.free_to_read_start_date %}
                    <dt>Datum slobodnog pristupa</dt>
                    <dd>{{ article.free_to_read_start_date|date:"d.m.Y." }}</dd>
                    {% endif %}
                </dl>
                {% if not article.license_url and not article.license_applies_to %}
                <p class="text-muted mb-0">Nema unetih podataka o licenci.</p>
                {% endif %}
            </div>
        </div>

        <!-- Metadata Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Metapodaci</h5>
            </div>
            <div class="card-body">
                <dl class="mb-0">
                    <dt>Kreirao</dt>
                    <dd>{{ article.created_by|default:"-" }}</dd>

                    <dt>Kreirano</dt>
                    <dd>{{ article.created_at|date:"d.m.Y. H:i" }}</dd>

                    <dt>Ažurirano</dt>
                    <dd>{{ article.updated_at|date:"d.m.Y. H:i" }}</dd>
                </dl>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Brze akcije</h5>
            </div>
            <div class="list-group list-group-flush">
                {% if can_edit %}
                <a href="{% url 'articles:update' article.pk %}" class="list-group-item list-group-item-action">
                    <i class="bi bi-pencil me-2"></i>Izmeni članak
                </a>
                {% endif %}
                {% if can_submit %}
                <button type="button" class="list-group-item list-group-item-action text-primary"
                        hx-get="{% url 'articles:article-submit-check' pk=article.pk %}"
                        hx-target="#submit-modal-container"
                        hx-swap="innerHTML">
                    <i class="bi bi-send me-2"></i>Pošalji na pregled
                </button>
                {% endif %}
                {% if can_review %}
                <button type="button" class="list-group-item list-group-item-action text-success"
                        hx-get="{% url 'articles:article-approve-check' pk=article.pk %}"
                        hx-target="#approve-modal-container"
                        hx-swap="innerHTML">
                    <i class="bi bi-check-circle me-2"></i>Odobri
                </button>
                <button type="button" class="list-group-item list-group-item-action text-warning"
                        hx-get="{% url 'articles:article-return-check' pk=article.pk %}"
                        hx-target="#return-modal-container"
                        hx-swap="innerHTML">
                    <i class="bi bi-arrow-return-left me-2"></i>Vrati na doradu
                </button>
                {% endif %}
                {% if can_publish %}
                <button type="button" class="list-group-item list-group-item-action text-success"
                        hx-get="{% url 'articles:article-publish-check' pk=article.pk %}"
                        hx-target="#publish-modal-container"
                        hx-swap="innerHTML">
                    <i class="bi bi-globe me-2"></i>Objavi
                </button>
                {% endif %}
                {% if can_withdraw %}
                <button type="button" class="list-group-item list-group-item-action text-danger"
                        hx-get="{% url 'articles:article-withdraw-check' pk=article.pk %}"
                        hx-target="#withdraw-modal-container"
                        hx-swap="innerHTML">
                    <i class="bi bi-x-circle me-2"></i>Povuci
                </button>
                {% endif %}
                <a href="{% url 'articles:list' %}?issue={{ article.issue.pk }}" class="list-group-item list-group-item-action">
                    <i class="bi bi-file-earmark-text me-2"></i>Svi članci ovog izdanja
                </a>
                <a href="{% url 'articles:list' %}" class="list-group-item list-group-item-action">
                    <i class="bi bi-list-ul me-2"></i>Svi članci
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Submit Review Modal Container (Story 3.5) -->
<div class="modal fade" id="submitReviewModal" tabindex="-1">
    <div id="submit-modal-container">
        <!-- HTMX will inject modal content here -->
    </div>
</div>

<!-- Approve Modal Container (Story 3.6) -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div id="approve-modal-container">
        <!-- HTMX will inject modal content here -->
    </div>
</div>

<!-- Return for Revision Modal Container (Story 3.6) -->
<div class="modal fade" id="returnRevisionModal" tabindex="-1">
    <div id="return-modal-container">
        <!-- HTMX will inject modal content here -->
    </div>
</div>

<!-- Publish Modal Container (Story 3.7) -->
<div class="modal fade" id="publishModal" tabindex="-1">
    <div id="publish-modal-container">
        <!-- HTMX will inject modal content here -->
    </div>
</div>

<!-- Withdraw Modal Container (Story 3.7) -->
<div class="modal fade" id="withdrawModal" tabindex="-1">
    <div id="withdraw-modal-container">
        <!-- HTMX will inject modal content here -->
    </div>
</div>

<script>
    document.body.addEventListener('htmx:afterSwap', function(event) {
        var targetId = event.detail.target.id;
        var modalMap = {
            'submit-modal-container': 'submitReviewModal',
            'approve-modal-container': 'approveModal',
            'return-modal-container': 'returnRevisionModal',
            'publish-modal-container': 'publishModal',
            'withdraw-modal-container': 'withdrawModal'
        };
        var modalId = modalMap[targetId];
        if (modalId) {
            bootstrap.Modal.getOrCreateInstance(document.getElementById(modalId)).show();
        }
    });
</script>
{% endblock %}
