{% extends "admin_base.html" %}

{% block title %}{{ form_title }} - DOI Portal{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">{{ form_title }}</h5>
            </div>
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}

                    <!-- Form Errors Summary -->
                    {% if form.errors %}
                    <div class="alert alert-danger mb-4">
                        <h6 class="alert-heading mb-2">
                            <i class="bi bi-exclamation-triangle me-2"></i>Ispravite sledeće greške:
                        </h6>
                        <ul class="mb-0">
                            {% for field in form %}
                                {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Basic Fields Section -->
                    <h6 class="text-muted mb-3 border-bottom pb-2">Osnovne informacije</h6>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_issue" class="form-label">Izdanje <span class="text-danger">*</span></label>
                            {{ form.issue }}
                            {% if form.issue.errors %}
                            <div class="invalid-feedback d-block">{{ form.issue.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_doi_suffix" class="form-label">DOI sufiks <span class="text-danger">*</span></label>
                            {{ form.doi_suffix }}
                            {% if form.doi_suffix.errors %}
                            <div class="invalid-feedback d-block">{{ form.doi_suffix.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="id_title" class="form-label">Naslov <span class="text-danger">*</span></label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="invalid-feedback d-block">{{ form.title.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="id_subtitle" class="form-label">Podnaslov</label>
                        {{ form.subtitle }}
                        {% if form.subtitle.errors %}
                        <div class="invalid-feedback d-block">{{ form.subtitle.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Abstract with character count -->
                    <div x-data="{ charCount: 0 }" class="mb-3">
                        <label for="id_abstract" class="form-label">Apstrakt</label>
                        <textarea name="abstract" id="id_abstract" class="form-control{% if form.abstract.errors %} is-invalid{% endif %}" rows="6"
                                  placeholder="Unesite apstrakt članka"
                                  x-on:input="charCount = $el.value.length"
                                  x-init="charCount = $el.value.length">{{ form.abstract.value|default:'' }}</textarea>
                        <small class="text-muted"><span x-text="charCount"></span> karaktera</small>
                        {% if form.abstract.errors %}
                        <div class="invalid-feedback d-block">{{ form.abstract.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Keywords tag input -->
                    {% if form.instance.pk and form.instance.keywords %}
                    {{ form.instance.keywords|json_script:"initial-keywords" }}
                    {% endif %}
                    <div x-data="keywordsInput()" class="mb-3">
                        <label class="form-label">Ključne reči</label>
                        <div class="d-flex flex-wrap gap-1 mb-2">
                            <template x-for="(keyword, index) in keywords" :key="index">
                                <span class="badge bg-primary d-flex align-items-center gap-1">
                                    <span x-text="keyword"></span>
                                    <button type="button" class="btn-close btn-close-white"
                                            @click="removeKeyword(index)" style="font-size: 0.6em;"></button>
                                </span>
                            </template>
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" x-model="newKeyword"
                                   @keydown.enter.prevent="addKeyword()"
                                   placeholder="Unesite ključnu reč i pritisnite Enter">
                            <button type="button" class="btn btn-outline-secondary" @click="addKeyword()">Dodaj</button>
                        </div>
                        <input type="hidden" name="keywords" :value="JSON.stringify(keywords)">
                    </div>

                    <!-- Page/Article Number Fields -->
                    <h6 class="text-muted mb-3 border-bottom pb-2">Stranice i identifikacija</h6>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="id_first_page" class="form-label">Prva stranica</label>
                            {{ form.first_page }}
                            {% if form.first_page.errors %}
                            <div class="invalid-feedback d-block">{{ form.first_page.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="id_last_page" class="form-label">Poslednja stranica</label>
                            {{ form.last_page }}
                            {% if form.last_page.errors %}
                            <div class="invalid-feedback d-block">{{ form.last_page.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="id_article_number" class="form-label">Broj članka</label>
                            {{ form.article_number }}
                            <div class="form-text">Za online-only članke</div>
                            {% if form.article_number.errors %}
                            <div class="invalid-feedback d-block">{{ form.article_number.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="id_language" class="form-label">Jezik</label>
                            {{ form.language }}
                            {% if form.language.errors %}
                            <div class="invalid-feedback d-block">{{ form.language.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Content Type and License Section -->
                    <h6 class="text-muted mb-3 border-bottom pb-2">Tip sadržaja i licenca</h6>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_publication_type" class="form-label">Tip sadržaja</label>
                            {{ form.publication_type }}
                            {% if form.publication_type.errors %}
                            <div class="invalid-feedback d-block">{{ form.publication_type.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_license_applies_to" class="form-label">Licenca se odnosi na</label>
                            {{ form.license_applies_to }}
                            {% if form.license_applies_to.errors %}
                            <div class="invalid-feedback d-block">{{ form.license_applies_to.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_license_url" class="form-label">URL licence</label>
                            {{ form.license_url }}
                            {% if form.license_url.errors %}
                            <div class="invalid-feedback d-block">{{ form.license_url.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="id_free_to_read_start_date" class="form-label">Datum slobodnog pristupa</label>
                            {{ form.free_to_read_start_date }}
                            {% if form.free_to_read_start_date.errors %}
                            <div class="invalid-feedback d-block">{{ form.free_to_read_start_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <div class="form-check mb-3">
                                {{ form.free_to_read }}
                                <label class="form-check-label" for="id_free_to_read">Slobodan pristup</label>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'articles:list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Nazad
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>{{ submit_text }}
                        </button>
                    </div>
                </form>

                <script>
                    function keywordsInput() {
                        return {
                            keywords: [],
                            newKeyword: '',
                            init() {
                                // Load existing keywords from json_script tag (safe JSON serialization)
                                const jsonEl = document.getElementById('initial-keywords');
                                if (jsonEl) {
                                    try {
                                        const existing = JSON.parse(jsonEl.textContent);
                                        if (Array.isArray(existing)) {
                                            this.keywords = existing;
                                        }
                                    } catch (e) {
                                        this.keywords = [];
                                    }
                                }
                            },
                            addKeyword() {
                                const trimmed = this.newKeyword.trim();
                                if (trimmed && !this.keywords.includes(trimmed)) {
                                    this.keywords.push(trimmed);
                                }
                                this.newKeyword = '';
                            },
                            removeKeyword(index) {
                                this.keywords.splice(index, 1);
                            }
                        }
                    }
                </script>
            </div>
        </div>

        <!-- Author Section (Edit Mode Only) - Story 3.2 -->
        {% if is_edit %}
        <div class="card mt-4" x-data="authorList()">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-people me-2"></i>Autori
                </h5>
                <button type="button" class="btn btn-sm btn-outline-primary"
                        hx-get="{% url 'articles:author-form' article_pk=object.pk %}"
                        hx-target="#author-form-container"
                        hx-swap="innerHTML">
                    <i class="bi bi-plus-lg me-1"></i>Dodaj autora
                </button>
            </div>
            <div class="card-body">
                <div id="author-form-container"></div>
                <div id="authors-section-content">
                    {% include "articles/partials/_author_list.html" with authors=authors %}
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<!-- Alpine.js for tag input and character count -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.3/dist/cdn.min.js"></script>
{% if is_edit %}
<!-- SortableJS for drag & drop author reordering -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
{% endif %}
{% endblock %}

{% block inline_javascript %}
{{ block.super }}
{% if is_edit %}
<script>
// CSRF token injection for all HTMX POST requests (required because CSRF_COOKIE_HTTPONLY=True)
document.body.addEventListener('htmx:configRequest', function(evt) {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        evt.detail.headers['X-CSRFToken'] = csrfInput.value;
    }
});

function authorList() {
    return {
        init() {
            this.$nextTick(() => {
                this.initSortable();
            });
            // Re-initialize after HTMX swaps
            document.body.addEventListener('htmx:afterSwap', (evt) => {
                if (evt.detail.target.id === 'authors-section-content') {
                    this.$nextTick(() => {
                        this.initSortable();
                    });
                }
            });
        },
        initSortable() {
            const el = document.getElementById('authors-container');
            if (el && el.children.length > 0) {
                new Sortable(el, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'bg-light',
                    onEnd: (evt) => {
                        const items = el.querySelectorAll('[data-author-id]');
                        const order = Array.from(items).map(item =>
                            parseInt(item.dataset.authorId)
                        );
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        htmx.ajax('POST', '{% url "articles:author-reorder" article_pk=object.pk %}', {
                            target: '#authors-section-content',
                            swap: 'innerHTML',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken,
                            },
                            body: JSON.stringify({order: order}),
                        });
                    }
                });
            }
        }
    }
}
</script>
{% endif %}
{% endblock %}
