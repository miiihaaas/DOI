{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Nova lozinka - DOI Portal{% endblock title %}

{% block bodyclass %}bg-light{% endblock bodyclass %}

{% block body %}
<div class="container">
  <div class="row justify-content-center mt-5">
    <div class="col-md-6 col-lg-4">
      <div class="card shadow">
        <div class="card-body p-4">
          <div class="text-center mb-4">
            <h2 class="card-title h4">Nova lozinka</h2>
          </div>

          {% if token_fail %}
            {# AC#3: Invalid/expired token handling (Task 9) #}
            <div class="alert alert-warning" role="alert">
              <strong>Link je istekao ili nije validan.</strong>
              <p class="mb-0 mt-2">
                Link za resetovanje lozinke je istekao ili je vec iskoriscen.
                Molimo zatrazite novi link.
              </p>
            </div>

            <div class="text-center mt-4">
              <a href="{% url 'account_reset_password' %}" class="btn btn-primary">
                Zatrazi novi link
              </a>
            </div>
          {% else %}
            {# AC#3/AC#4: Password policy info and form #}
            <div class="alert alert-info mb-4" role="alert">
              <small>
                <strong>Pravila za lozinku:</strong>
                <ul class="mb-0 mt-1">
                  <li>Najmanje 8 karaktera</li>
                  <li>Ne sme biti slicna vasem emailu</li>
                  <li>Ne sme biti cesta lozinka (npr. "password123")</li>
                </ul>
              </small>
            </div>

            {% if form.errors %}
              <div class="alert alert-danger" role="alert">
                {% for field in form %}
                  {% for error in field.errors %}
                    <p class="mb-0">{{ error }}</p>
                  {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                  <p class="mb-0">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}

            <form method="post" x-data="passwordForm()">
              {% csrf_token %}

              <div class="mb-3">
                <label for="id_password1" class="form-label">Nova lozinka</label>
                <input type="password"
                       name="password1"
                       id="id_password1"
                       class="form-control {% if form.password1.errors %}is-invalid{% endif %}"
                       placeholder="Unesite novu lozinku"
                       autocomplete="new-password"
                       x-model="password1"
                       required />
                {% if form.password1.errors %}
                  <div class="invalid-feedback">{{ form.password1.errors.0 }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="id_password2" class="form-label">Potvrdite lozinku</label>
                <input type="password"
                       name="password2"
                       id="id_password2"
                       class="form-control {% if form.password2.errors %}is-invalid{% endif %}"
                       placeholder="Ponovite novu lozinku"
                       autocomplete="new-password"
                       x-model="password2"
                       required />
                {% if form.password2.errors %}
                  <div class="invalid-feedback">{{ form.password2.errors.0 }}</div>
                {% endif %}
              </div>

              {# Alpine.js client-side password match validation (Task 5.5) #}
              <div x-show="!passwordsMatch && password2.length > 0"
                   x-cloak
                   role="alert"
                   aria-live="polite"
                   class="alert alert-warning py-2 small">
                Lozinke se ne poklapaju.
              </div>

              <button type="submit"
                      class="btn btn-primary w-100 mt-3"
                      :disabled="!passwordsMatch || password1.length < 8">
                Sacuvaj novu lozinku
              </button>
            </form>

            <div class="text-center mt-3">
              <a href="{% url 'account_login' %}" class="text-decoration-none text-muted">
                &larr; Nazad na prijavu
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function passwordForm() {
  return {
    password1: '',
    password2: '',
    get passwordsMatch() {
      if (this.password2.length === 0) return true;
      return this.password1 === this.password2;
    }
  }
}
</script>
{% endblock body %}
