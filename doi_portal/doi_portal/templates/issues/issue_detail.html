{% extends "admin_base.html" %}

{% block title %}{{ issue }} - DOI Portal{% endblock %}

{% block extra_css %}
{# Prism.js CSS for XML Preview (Story 5.5) #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-highlight/prism-line-highlight.min.css" />
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-collection me-2"></i>{{ issue }}
    </h1>
    <div>
        {% if can_edit %}
        <a href="{% url 'issues:update' issue.pk %}" class="btn btn-primary">
            <i class="bi bi-pencil me-1"></i>Izmeni
        </a>
        {% endif %}
        {% if can_delete %}
        <a href="{% url 'issues:delete' issue.pk %}" class="btn btn-outline-danger ms-2">
            <i class="bi bi-trash me-1"></i>Obriši
        </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Main Info Card -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Osnovne informacije</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-3">Publikacija</dt>
                    <dd class="col-sm-9">
                        <a href="{% url 'publications:detail' issue.publication.slug %}">
                            {{ issue.publication.title }}
                        </a>
                    </dd>

                    <dt class="col-sm-3">Izdavač</dt>
                    <dd class="col-sm-9">
                        <a href="{% url 'publishers:detail' issue.publication.publisher.pk %}">
                            {{ issue.publication.publisher.name }}
                        </a>
                    </dd>

                    <dt class="col-sm-3">Volumen</dt>
                    <dd class="col-sm-9">{{ issue.volume|default:"-" }}</dd>

                    <dt class="col-sm-3">Broj izdanja</dt>
                    <dd class="col-sm-9">{{ issue.issue_number|default:"-" }}</dd>

                    <dt class="col-sm-3">Godina</dt>
                    <dd class="col-sm-9">{{ issue.year }}</dd>

                    {% if issue.title %}
                    <dt class="col-sm-3">Naslov</dt>
                    <dd class="col-sm-9">{{ issue.title }}</dd>
                    {% endif %}

                    <dt class="col-sm-3">Status</dt>
                    <dd class="col-sm-9">
                        <span class="badge {{ issue.status_badge_class }}">
                            {{ issue.get_status_display }}
                        </span>
                    </dd>

                    {% if issue.publication_date %}
                    <dt class="col-sm-3">Datum objave</dt>
                    <dd class="col-sm-9">{{ issue.publication_date|date:"d.m.Y." }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        <!-- Conference Proceedings Fields -->
        {% if issue.publication.publication_type == "CONFERENCE" %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Podaci o zborniku</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    {% if issue.proceedings_title %}
                    <dt class="col-sm-3">Naslov zbornika</dt>
                    <dd class="col-sm-9">{{ issue.proceedings_title }}</dd>
                    {% endif %}

                    {% if issue.proceedings_publisher_name %}
                    <dt class="col-sm-3">Izdavač zbornika</dt>
                    <dd class="col-sm-9">{{ issue.proceedings_publisher_name }}</dd>
                    {% endif %}

                    {% if issue.proceedings_publisher_place %}
                    <dt class="col-sm-3">Mesto izdavanja</dt>
                    <dd class="col-sm-9">{{ issue.proceedings_publisher_place }}</dd>
                    {% endif %}
                </dl>
                {% if not issue.proceedings_title and not issue.proceedings_publisher_name and not issue.proceedings_publisher_place %}
                <p class="text-muted mb-0">Nema unetih podataka o zborniku.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Articles Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Članci ({{ issue.articles.count }})</h5>
                {% if can_edit %}
                <a href="{% url 'articles:create' %}?issue={{ issue.pk }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus-lg me-1"></i>Dodaj članak
                </a>
                {% endif %}
            </div>
            {% if issue.articles.exists %}
            <div class="list-group list-group-flush">
                {% for article in issue.articles.all %}
                <a href="{% url 'articles:detail' article.pk %}" class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="me-3" style="min-width: 0;">
                            <h6 class="mb-1 text-truncate">{{ article.title }}</h6>
                            <small class="text-muted">
                                {% for author in article.authors.all %}
                                    {{ author.surname }} {{ author.given_name|slice:":1" }}.{% if not forloop.last %}, {% endif %}
                                {% empty %}
                                    <em>Nema autora</em>
                                {% endfor %}
                            </small>
                        </div>
                        <div class="text-end text-nowrap">
                            <span class="badge {{ article.status_badge_class }}">{{ article.get_status_display }}</span>
                            {% if article.first_page %}
                            <br><small class="text-muted">str. {{ article.first_page }}{% if article.last_page %}-{{ article.last_page }}{% endif %}</small>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body">
                <p class="text-muted mb-0">Nema članaka u ovom izdanju.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Cover Image -->
        {% if issue.cover_image %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Naslovna slika</h5>
            </div>
            <div class="card-body text-center">
                <img src="{{ issue.cover_image.url }}" alt="{{ issue }} naslovna slika"
                     class="img-fluid rounded">
            </div>
        </div>
        {% endif %}

        <!-- Metadata Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Metapodaci</h5>
            </div>
            <div class="card-body">
                <dl class="mb-0">
                    <dt>Kreirano</dt>
                    <dd>{{ issue.created_at|date:"d.m.Y. H:i" }}</dd>

                    <dt>Ažurirano</dt>
                    <dd>{{ issue.updated_at|date:"d.m.Y. H:i" }}</dd>

                    <dt>Broj članaka</dt>
                    <dd>{{ issue.article_count }}</dd>
                </dl>
            </div>
        </div>

        <!-- Crossref XML Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-code-square me-2"></i>Crossref XML</h5>
            </div>
            <div class="card-body">
                {% if issue.crossref_xml %}
                <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-success me-2">
                        <i class="bi bi-check-circle me-1"></i>Generisan
                    </span>
                    <small class="text-muted">{{ issue.xml_generated_at|date:"d.m.Y. H:i" }}</small>
                </div>
                {% if issue.xsd_valid %}
                <div class="small text-success mb-3">
                    <i class="bi bi-shield-check me-1"></i>XSD validacija uspešna
                </div>
                {% elif issue.xsd_valid is False %}
                <div class="small text-danger mb-3">
                    <i class="bi bi-shield-x me-1"></i>XSD validacija: {{ issue.xsd_errors|length }} greške
                </div>
                {% endif %}
                <div class="d-grid gap-2">
                    <button type="button"
                            id="xmlPreviewBtn"
                            class="btn btn-outline-primary"
                            onclick="loadXmlPreview()">
                        <i class="bi bi-eye me-1"></i>Pregled XML
                    </button>
                    <a href="{% url 'crossref:xml-download' issue.pk %}" class="btn btn-outline-secondary" download>
                        <i class="bi bi-download me-1"></i>Preuzmi XML
                    </a>
                </div>
                {% else %}
                <p class="text-muted mb-3">
                    <i class="bi bi-info-circle me-1"></i>XML nije generisan.
                </p>
                {# Validation panel loads here via HTMX #}
                <div id="validation-panel"
                     hx-get="{% url 'crossref:issue-validate' issue.pk %}"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <div class="text-center py-2">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Učitavanje...</span>
                        </div>
                    </div>
                </div>
                {# Generate XML button #}
                <div id="generation-result" class="mt-3">
                    <button type="button"
                            class="btn btn-primary w-100"
                            hx-post="{% url 'crossref:issue-generate' issue.pk %}"
                            hx-target="#generation-result"
                            hx-swap="innerHTML"
                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                        <i class="bi bi-file-code me-1"></i>Generiši XML
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Brze akcije</h5>
            </div>
            <div class="list-group list-group-flush">
                {% if can_edit %}
                <a href="{% url 'issues:update' issue.pk %}" class="list-group-item list-group-item-action">
                    <i class="bi bi-pencil me-2"></i>Izmeni izdanje
                </a>
                {% endif %}
                <a href="{% url 'issues:list' %}?publication={{ issue.publication.pk }}" class="list-group-item list-group-item-action">
                    <i class="bi bi-collection me-2"></i>Sva izdanja ove publikacije
                </a>
                <a href="{% url 'publications:detail' issue.publication.slug %}" class="list-group-item list-group-item-action">
                    <i class="bi bi-journal-text me-2"></i>Detalji publikacije
                </a>
            </div>
        </div>
    </div>
</div>

{# Prism.js Scripts for XML Preview (Story 5.5) #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-highlight/prism-line-highlight.min.js"></script>

<script>
function loadXmlPreview() {
    fetch('{% url "crossref:xml-preview" issue.pk %}')
        .then(response => response.text())
        .then(html => {
            // Remove existing modal if present
            const existingModal = document.getElementById('xmlPreviewModal');
            if (existingModal) {
                existingModal.remove();
            }
            // Insert modal HTML into body
            document.body.insertAdjacentHTML('beforeend', html);
            // Show the modal
            const modal = document.getElementById('xmlPreviewModal');
            if (modal) {
                const bsModal = new bootstrap.Modal(modal);

                // Initialize Prism.js syntax highlighting after modal is shown
                modal.addEventListener('shown.bs.modal', function() {
                    const codeBlock = modal.querySelector('code.language-xml');
                    if (codeBlock && typeof Prism !== 'undefined') {
                        Prism.highlightElement(codeBlock);
                    }
                });

                // Clean up modal from DOM when closed
                modal.addEventListener('hidden.bs.modal', function() {
                    modal.remove();
                });

                bsModal.show();
            }
        })
        .catch(error => {
            console.error('Error loading XML preview:', error);
            alert('Greška pri učitavanju XML pregleda');
        });
}

function copyXmlToClipboard() {
    const codeBlock = document.querySelector('#xmlPreviewModal code');
    if (!codeBlock) return;

    const xmlContent = codeBlock.textContent;

    navigator.clipboard.writeText(xmlContent).then(() => {
        showXmlToast('XML kopiran u clipboard', 'success');
    }).catch(err => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = xmlContent;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showXmlToast('XML kopiran u clipboard', 'success');
        } catch (e) {
            showXmlToast('Greška pri kopiranju', 'danger');
        }
        document.body.removeChild(textArea);
    });
}

function showXmlToast(message, type) {
    const toastContainer = document.getElementById('xmlPreviewToast');
    if (!toastContainer) return;

    const toastId = 'toast-' + Date.now();
    const iconClass = type === 'success' ? 'check-circle' : 'x-circle';

    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-bg-${type}" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${iconClass} me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
}
</script>
{% endblock %}
